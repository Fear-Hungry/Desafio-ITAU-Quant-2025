name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      run_data_validation:
        description: "Run offline data validation smoke test"
        required: false
        default: "false"

jobs:
  test:
    name: Test Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.8.2
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root

      - name: Install project
        run: poetry install --no-interaction

      - name: Run tests with coverage
        run: |
          poetry run pytest --cov=src/arara_quant --cov-report=xml --cov-report=term-missing --cov-fail-under=70

      - name: Check coverage threshold
        if: matrix.python-version == '3.11'
        run: |
          poetry run coverage report --fail-under=70

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: matrix.python-version == '3.11'
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.8.2

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Run ruff linter
        run: poetry run ruff check src tests

      - name: Run black formatter check
        run: poetry run black --check src tests

  type-check:
    name: Type Check with mypy
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.8.2

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Run mypy
        run: poetry run mypy src --ignore-missing-imports --no-strict-optional
        continue-on-error: true  # Don't fail CI on type errors initially

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test, lint]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.8.2
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-3.11-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root

      - name: Install project
        run: poetry install --no-interaction

      - name: Run estimator tests
        run: poetry run pytest tests/estimators/ -v

      - name: Run optimization tests
        run: poetry run pytest tests/optimization/ -v

      - name: Run backtesting tests
        run: poetry run pytest tests/backtesting/ -v

  data-smoke:
    name: Offline Data Validation Smoke
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.run_data_validation == 'true' }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.8.2
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-3.11-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root

      - name: Install project
        run: poetry install --no-interaction

      - name: Run offline data validation smoke
        run: poetry run python scripts/validation/offline_data_smoke.py

  validate-configs:
    name: Validate Configuration Files
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.8.2

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Validate universe configs
        run: |
          poetry run python -c "
          from itau_quant.config import load_config, UniverseConfig
          import sys
          from pathlib import Path

          configs_dir = Path('configs')
          universe_configs = list(configs_dir.glob('universe_*.yaml'))

          if not universe_configs:
              print('No universe configs found')
              sys.exit(0)

          for config_file in universe_configs:
              print(f'Validating {config_file}...')
              try:
                  cfg = load_config(str(config_file), UniverseConfig)
                  print(f'  ✓ {config_file.name}: {len(cfg.tickers)} tickers')
              except Exception as e:
                  print(f'  ✗ {config_file.name}: {e}')
                  sys.exit(1)
          "

      - name: Validate portfolio configs
        run: |
          poetry run python -c "
          from itau_quant.config import load_config, PortfolioConfig
          import sys
          from pathlib import Path

          configs_dir = Path('configs')
          portfolio_configs = list(configs_dir.glob('portfolio_*.yaml'))

          if not portfolio_configs:
              print('No portfolio configs found')
              sys.exit(0)

          for config_file in portfolio_configs:
              print(f'Validating {config_file}...')
              try:
                  cfg = load_config(str(config_file), PortfolioConfig)
                  print(f'  ✓ {config_file.name}: risk_aversion={cfg.risk_aversion}')
              except Exception as e:
                  print(f'  ✗ {config_file.name}: {e}')
                  sys.exit(1)
          "

  status-check:
    name: All CI Checks Passed
    runs-on: ubuntu-latest
    needs: [test, lint, type-check, integration, validate-configs]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          echo "Test: ${{ needs.test.result }}"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Type Check: ${{ needs.type-check.result }}"
          echo "Integration: ${{ needs.integration.result }}"
          echo "Config Validation: ${{ needs.validate-configs.result }}"

          if [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.integration.result }}" != "success" ] || \
             [ "${{ needs.validate-configs.result }}" != "success" ]; then
            echo "❌ One or more critical checks failed"
            exit 1
          fi

          echo "✅ All CI checks passed successfully!"
